pipeline {
  agent any

  tools {
    gradle 'gradle-7.6.1'
    jdk 'jdk-17'
  }

  parameters {
    string(name: 'GITHUB_USERNAME', defaultValue: '2025-07-JAVA-DEVELOPER-162', description: 'GitHub 사용자명을 입력하세요.')
  }

  environment {
    GITHUB_SCRIPT_URL = "https://github.com/${GITHUB_USERNAME}/aws-guest-script.git"

    EC2_USER='ubuntu'
    EC2_HOST='43.203.168.108'
    EC2_APP_DIR='/home/ubuntu/aws-guest-script'
    STEP_NUM='step4'
    DOCKER_COMPOSE_MYSQL_FILE='docker-compose-mysql-image.yml'
    DOCKER_COMPOSE_GUEST_FILE='docker-compose-guest-image.yml'

    EC2_SSH_CREDENTIALS='deploy-ssh-key'
    DOCKERHUB_CREDENTIALS='dockerhub-credentials'
  }

  stages {
    stage('EC2 블루 배포') {
      steps {
        sshagent([env.EC2_SSH_CREDENTIALS]) {
          sh '''
ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} <<'EOF'
set -e
echo "[EC2][BLUE] 배포 디렉토리: ${EC2_APP_DIR}"

rm -rf "${EC2_APP_DIR}"
mkdir -p "${EC2_APP_DIR}"
cd "${EC2_APP_DIR}"

echo "[EC2][BLUE] Git sparse checkout: ${GITHUB_SCRIPT_URL}"
git init
git remote add origin ${GITHUB_SCRIPT_URL}
git config core.sparseCheckout true
echo "${STEP_NUM}/deploy/" >> .git/info/sparse-checkout
git pull origin main

ls -al

# 네트워크/볼륨
docker network inspect guest_network >/dev/null 2>&1 || docker network create guest_network
docker volume inspect mysql_volume >/dev/null 2>&1 || docker volume create mysql_volume

docker compose -f ./${STEP_NUM}/deploy/blue/${DOCKER_COMPOSE_MYSQL_FILE} pull || true
docker compose -f ./${STEP_NUM}/deploy/blue/${DOCKER_COMPOSE_GUEST_FILE} pull || true

docker compose -f ./${STEP_NUM}/deploy/blue/${DOCKER_COMPOSE_MYSQL_FILE} down || true
docker compose -f ./${STEP_NUM}/deploy/blue/${DOCKER_COMPOSE_GUEST_FILE} down || true

docker compose -f ./${STEP_NUM}/deploy/blue/${DOCKER_COMPOSE_MYSQL_FILE} up -d
docker compose -f ./${STEP_NUM}/deploy/blue/${DOCKER_COMPOSE_GUEST_FILE} up -d

docker compose -f ./${STEP_NUM}/deploy/blue/${DOCKER_COMPOSE_MYSQL_FILE} ps
docker compose -f ./${STEP_NUM}/deploy/blue/${DOCKER_COMPOSE_GUEST_FILE} ps
EOF
'''
        }
      }
    }

    stage('Green 자동배포 시작') {
      steps {
        input message: '자동배포 시작', ok: "Yes"
      }
    }

    stage('EC2 그린 배포') {
      steps {
        sshagent([env.EC2_SSH_CREDENTIALS]) {
          sh '''
ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} <<'EOF'
set -e
echo "[EC2][GREEN] 배포 디렉토리: ${EC2_APP_DIR}"

rm -rf "${EC2_APP_DIR}"
mkdir -p "${EC2_APP_DIR}"
cd "${EC2_APP_DIR}"

echo "[EC2][GREEN] Git sparse checkout: ${GITHUB_SCRIPT_URL}"
git init
git remote add origin ${GITHUB_SCRIPT_URL}
git config core.sparseCheckout true
echo "${STEP_NUM}/deploy/" >> .git/info/sparse-checkout
git pull origin main

ls -al

docker network inspect guest_network >/dev/null 2>&1 || docker network create guest_network
docker volume inspect mysql_volume >/dev/null 2>&1 || docker volume create mysql_volume

docker compose -f ./${STEP_NUM}/deploy/green/${DOCKER_COMPOSE_MYSQL_FILE} pull || true
docker compose -f ./${STEP_NUM}/deploy/green/${DOCKER_COMPOSE_MYSQL_FILE} up -d || true

docker compose -f ./${STEP_NUM}/deploy/green/${DOCKER_COMPOSE_GUEST_FILE} pull || true

docker compose -f ./${STEP_NUM}/deploy/green/${DOCKER_COMPOSE_GUEST_FILE} down || true
docker compose -f ./${STEP_NUM}/deploy/green/${DOCKER_COMPOSE_GUEST_FILE} up -d
docker compose -f ./${STEP_NUM}/deploy/green/${DOCKER_COMPOSE_GUEST_FILE} ps
EOF
'''
        }
      }
    }
  }

  post {
    success { echo "✅ EC2 그린 배포 성공!" }
    failure { echo "❌ EC2 그린 실패. 콘솔 로그를 확인하세요." }
  }
}
